Feature: Egress-ingress related networking scenarios

# @author weliang@redhat.com
  # @case_id OCP-13499
  @admin
  Scenario: Change the order of allow and deny rules in egress network policy
    Given the env is using multitenant network
    Given I have a project  
    Given I have a pod-for-ping in the project
    And evaluation of `project.name` is stored in the :proj1 clipboard

    # Create egress policy with allow and deny order
    And evaluation of `CucuShift::Common::Net.dns_lookup("yahoo.com")` is stored in the :yahoo_ip clipboard
    When I download a file from "https://raw.githubusercontent.com/openshift-qe/v3-testfiles/master/networking/egress-ingress/dns-egresspolicy1.json"
    And I replace lines in "dns-egresspolicy1.json":
      | 98.138.0.0/16 | <%= cb.yahoo_ip %>/32 |
    And I run the :create admin command with:
      | f | dns-egresspolicy1.json |
      | n | <%= cb.proj1 %> |
    Then the step should succeed

    # Check ping from pod
    When I execute on the pod:
      | ping | -c1 | -W2 | yahoo.com |
    Then the step should succeed
    When I execute on the pod:
      | ping | -c1 | -W2 | <%= cb.yahoo_ip %> | 
    Then the step should succeed
    
    # Check egress policy can be deleted
    When I run the :delete admin command with:
      | object_type       | egressnetworkpolicy |
      | object_name_or_id | policy-test             |
      | n                 |  <%= cb.proj1 %>    |
    Then the step should succeed
 
    # Create new egress policy with deny and allow order
    When I download a file from "https://raw.githubusercontent.com/openshift-qe/v3-testfiles/master/networking/egress-ingress/dns-egresspolicy2.json"
    And I replace lines in "dns-egresspolicy2.json":
      | 98.138.0.0/16 | <%= cb.yahoo_ip %>/32 |
    And I run the :create admin command with:
      | f | dns-egresspolicy2.json |
      | n | <%= cb.proj1 %> |
    Then the step should succeed
 
    # Check ping from pod
    When I execute on the pod:
      | ping | -c1 | -W2 | yahoo.com |
    Then the step should fail
    When I execute on the pod:
      | ping | -c1 | -W2 | <%= cb.yahoo_ip %> | 
    Then the step should fail
